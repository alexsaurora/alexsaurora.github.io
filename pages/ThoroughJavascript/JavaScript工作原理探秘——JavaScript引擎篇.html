<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、JavaScript引擎介绍 | 一凡的博客</title>
    <meta name="description" content="我的心路历程">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.4dce7a13.css" as="style"><link rel="preload" href="/assets/js/app.5f5d3fba.js" as="script"><link rel="preload" href="/assets/js/6.e1ba9e42.js" as="script"><link rel="prefetch" href="/assets/js/2.811a7462.js"><link rel="prefetch" href="/assets/js/3.5c1afac9.js"><link rel="prefetch" href="/assets/js/4.19090317.js"><link rel="prefetch" href="/assets/js/5.45cea147.js"><link rel="prefetch" href="/assets/js/7.20f4a82b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4dce7a13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一凡的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">深入JavaScript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ThoroughJavascript/JavaScript工作原理探秘——JavaScript引擎篇.html" class="nav-link">工作原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Framework/React/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/pages/Framework/Vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><a href="/pages/Node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/pages/DataVisualization/数据可视化框架对比.html" class="nav-link">数据可视化</a></div><div class="nav-item"><a href="/pages/Other/前端快速重装工具集.html" class="nav-link">其他</a></div><div class="nav-item"><a href="/pages/Engineer/" class="nav-link">工程化</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">优秀博客</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Troland/how-javascript-works" target="_blank" rel="noopener noreferrer" class="nav-link external">
  how-javascript-works中文译文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">个人主页</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/alexsaurora" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://juejin.im/user/5a57310351882573520d522b/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/yichensheng" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">深入JavaScript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ThoroughJavascript/JavaScript工作原理探秘——JavaScript引擎篇.html" class="nav-link">工作原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Framework/React/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/pages/Framework/Vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><a href="/pages/Node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/pages/DataVisualization/数据可视化框架对比.html" class="nav-link">数据可视化</a></div><div class="nav-item"><a href="/pages/Other/前端快速重装工具集.html" class="nav-link">其他</a></div><div class="nav-item"><a href="/pages/Engineer/" class="nav-link">工程化</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">优秀博客</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Troland/how-javascript-works" target="_blank" rel="noopener noreferrer" class="nav-link external">
  how-javascript-works中文译文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">个人主页</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/alexsaurora" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://juejin.im/user/5a57310351882573520d522b/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/yichensheng" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>工作原理</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/pages/ThoroughJavascript/JavaScript工作原理探秘——JavaScript引擎篇.html" class="active sidebar-link">JavaScript工作原理探秘——JavaScript引擎篇</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><p><img src="https://imgkr.cn-bj.ufileos.com/6e4cca95-87e0-4935-a4e6-e2c650dbd57a.png" alt></p> <p>我们每天都在写的JavaScript是怎么运行的？</p> <p>准确地说，Javascript 在其运行时环境上是如何工作的才对，Node 和 浏览器都是 Javascript 的运行时环境。这篇文章我们来探索下运行时环境的核心——JavaScript引擎。</p> <h3 id="一、javascript引擎介绍"><a href="#一、javascript引擎介绍" class="header-anchor">#</a> 一、JavaScript引擎介绍</h3> <p><strong>JavaScript 引擎</strong>是什么：一种用于将我们的代码转换为机器可读语言的引擎。</p> <p><strong>JavaScript引擎作用</strong>：将js代码编译成机器码，还负责执行代码、分配内存以及垃圾回收。</p> <h4 id="解释器和编译器"><a href="#解释器和编译器" class="header-anchor">#</a> 解释器和编译器</h4> <p>我们已经知道了JavaScript引擎就是为了把JavaScript代码转换为机器可读语言，通常来说转换方法有两种：</p> <ul><li><p><strong>解释器 Interpreter</strong>，逐行解释代码并立即执行</p></li> <li><p><strong>编译器 Compiler</strong> ，读取整个代码，进行一些优化，生成对应的机器代码</p></li></ul> <p>我们来看一个例子：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>编译器会把<code>sum +=i;</code>编译成机器码，然后运行机器码1000次，速度比较快；</p> <p>解释器会把<code>sum +=i;</code>转换编译1000次，性能不高；</p> <p>解释器和编译器的优缺点：</p> <ul><li>解释器优点在于无需等待编译，立即执行代码。这对于在浏览器上执行JavaScript提供了极大的便利。但是当有大量的js代码需要执行时就会比较慢，例如大量循环操作</li> <li>编译器需要花费一些时间来编译代码，进行一些优化工作，最终生成执行优化过的代码</li></ul> <p>为了综合利用解释器和编译器，提高程序编译、执行速度，出现了**JIT（Just In Time）**即时编译技术，它在执行前进行编译，现代浏览器大都实现了这一功能。</p> <h4 id="jit工作原理："><a href="#jit工作原理：" class="header-anchor">#</a> JIT工作原理：</h4> <ul><li><p>第一步使用解释器执行源码，当某一行代码被执行了几次，这行代码就会打上<strong>Warm</strong>标签；当某行代码被执行了很多次，就会打上<strong>Hot标签</strong></p></li> <li><p>第二步，被打上 <strong>Warm</strong> 标签的代码会被传给<strong>Baseline Compiler</strong> 编译且储存，同时按照<strong>行数 (Line number)</strong> 和<strong>变量类型 (Variable type)</strong> 被索引。</p> <p>例如上面的例子<code>sum+=i</code>，因为js的动态类型，编译结果可能会有很多种：</p> <ul><li>sum是number类型，这里的+就是加法运算</li> <li>sum是string类型，这里的+就是字符串拼接，并把i转为string类型</li> <li>sum是boolean类型，会把sum转为number类型再进行加法运算</li> <li>。。。</li></ul> <p>因为不同的变量类型会对应不同的编译结果，所以编译后的代码要使用行数和变量类型做索引。</p> <p>当发现执行的代码命中索引，会直接取出编译后的代码执行，从而不需要重复编译已经编译过的代码</p></li> <li><p>第三步，被打上 <strong>Hot</strong> 标签的代码会被传给 <strong>Optimizing compiler</strong>，这里会对这部分代码做更优化的编译。怎么更优化？做一些关于变量类型和运行环境中值的假设，如果假设不成立就将这个优化的版本回退，如果假设成立的话，这将让代码性能更高。</p> <p>JIT 直接假设一个前提，比如这里我们直接假设 sum 是 number，i 也是 number，于是就只用一种编译结果就好了。实际上，在执行前会做类型检查，看是假设是否成立，如果不成立执行就会被打回 interpreter 或者 baseline compiler 的版本，这个操作叫做 &quot;反优化 (deoptimization)&quot;。</p> <p>可以看出，只要假设的成功率足够高，那么代码的执行速度就会快。但是如果假设的成功率很低，那么会导致比没有任何优化的时候还要慢（因为要经历 反优化 的过程）</p></li></ul> <p>JavaScript 运行速度的提升离不开 JIT compiler 的贡献，通过对<strong>多次执行的代码的编译结果的存储，以及对变量类型的合理推测</strong>，尽管存在运行时间加长的可能，但还是整体降低了 JavaScript 代码的平均执行时间。这也提醒我们保持一个很好的习惯就是不要随意修改一个变量的类型。</p> <h3 id="二、v8引擎"><a href="#二、v8引擎" class="header-anchor">#</a> 二、V8引擎</h3> <p>比较出名的JavaScript引擎有：</p> <ul><li><strong>V8</strong>，chrome浏览器、node.js</li> <li><strong>SpiderMonkey</strong>，火狐浏览器</li> <li><strong>JavaScriptCore</strong>，safari浏览器</li> <li><strong>Chakra</strong>，微软</li></ul> <p>由于V8是事实上最流行、性能最佳的JavaScript引擎，我们来看看它的构成。</p> <p>V8由很多子模块构成，其中有四个是最重要的：</p> <ul><li><strong>Parser</strong>：负责将JavaScript代码转换为AST抽象语法树</li> <li><strong>Ignition</strong>：interpreter，即解释器，负责将AST转换为ByteCode，解释执行ByteCode，同时执行TurboFan优化编译所需的信息，比如函数参数的类型</li> <li><strong>TurboFan</strong>：compiler，即编译器，利用Ignition收集的类型信息，将bytecode转为优化的汇编代码</li> <li><strong>Orinoco</strong>：garbage collector，垃圾回收模块，负责将程序不再需要的内存空间回收，使用标记清除的原理。</li></ul> <p>其流程图如下：</p> <p><img src="https://image.fundebug.com/2019-07-16-ignition-turbofan-pipeline.png" alt></p> <h3 id="三、javascript引擎解析js源码"><a href="#三、javascript引擎解析js源码" class="header-anchor">#</a> 三、JavaScript引擎解析js源码</h3> <p>分为两个阶段：语法检查和运行阶段。</p> <h4 id="第一阶段语法检查，分为词法分析和语法分析"><a href="#第一阶段语法检查，分为词法分析和语法分析" class="header-anchor">#</a> 第一阶段语法检查，分为词法分析和语法分析</h4> <h5 id="_1，词法分析"><a href="#_1，词法分析" class="header-anchor">#</a> 1，词法分析</h5> <p>JavaScript解释器将js源码按照ECMAScript标准转换为词法单元。例如，考虑程序 var a = 2;。</p> <p>这段程序通常会被分解成为下面这些词法单元：</p> <p><code>var、a、=、2 、;</code></p> <h5 id="_2，语法分析"><a href="#_2，语法分析" class="header-anchor">#</a> 2，语法分析</h5> <p>这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套所组成的代表了程序语法</p> <p>结构的树。这个树被称为“抽象语法树”（Abstract Syntax Tree，AST）。</p> <p>可以通过访问 <a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">AST Explorer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来查看实际的 AST 树。</p> <h4 id="第二阶段：运行阶段，也分为两个部分，预解析阶段和执行阶段"><a href="#第二阶段：运行阶段，也分为两个部分，预解析阶段和执行阶段" class="header-anchor">#</a> 第二阶段：运行阶段，也分为两个部分，预解析阶段和执行阶段</h4> <h5 id="_1，预解析阶段"><a href="#_1，预解析阶段" class="header-anchor">#</a> 1，预解析阶段</h5> <p>第一步：创建执行上下文，JavaScript引擎将语法检查正确后的AST复制到当前执行上下文中。</p> <p>创建的执行上下文包括：</p> <ul><li>变量对象，由变量声明、函数声明、参数（arguments）构成
<ul><li>引擎每次遇到声明语句，就会把声明传到作用域（scope）中创建一个绑定。每次声明都会为变量分配内存。只是分配内存，并不会修改源代码将变量声明语句提升。正如你所知道的，在JS中分配内存意味着将变量默认设为<code>undefined</code>。所以变量提升只是执行上下文的小把戏，不是真的源代码修改。</li></ul></li> <li>作用域链，由变量对象及所有的父级作用域构成</li> <li>this，this值在进入上下文阶段确定，一旦进入执行阶段this值不会再变化</li></ul> <p>第二步：属性填充，JavaScript引擎会对语法树当中的变量对象/活动对象（VO/AO）的变量声明、函数声明、形参进行属性填充</p> <p>填充顺序、比重为<strong>函数的形参-&gt;函数声明-&gt;变量声明</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> b<span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// function b(a) { alert(a); }</span>
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//undefined</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上代码在进入执行上下文时，按照函数的形参-&gt;函数声明-&gt;变量声明顺序来填充，并且优先权永远都是函数的形参&gt;函数声明&gt;变量声明，所以只要alert(a)中的a是函数中的形参，就永远不会被函数和变量声明覆盖。就算没有赋值也是默认填充的undefined值。</p> <h5 id="_2，执行阶段"><a href="#_2，执行阶段" class="header-anchor">#</a> 2，执行阶段</h5> <p>进入执行代码阶段，VO/AO就会重新赋予真实的值，“预解析”阶段赋予的undefined值会被覆盖。</p> <p>此阶段才是程序真正进入执行阶段，Javascript引擎会一行一行的读取并运行代码。此时那些变量都会重新赋值。</p> <p>假如变量是定义在函数内的，而函数从头到尾都没被激活（调用）的话，则变量值永远都是undefined值。</p> <h3 id="四、javascript引擎垃圾回收原理："><a href="#四、javascript引擎垃圾回收原理：" class="header-anchor">#</a> 四、JavaScript引擎垃圾回收原理：</h3> <p>目前主流的浏览器JavaScript引擎进行垃圾回收，都使用标记清除的原理，只有ie6、7浏览器使用引用计数的原理。</p> <h5 id="标记清除（mark-and-sweep）"><a href="#标记清除（mark-and-sweep）" class="header-anchor">#</a> 标记清除（mark and sweep）</h5> <p>这是JavaScript最常见的垃圾回收方式，当变量进入执行环境的时候，比如函数中声明一个变量，垃圾回收器将其标记为“进入环境”，当变量离开环境的时候（函数执行结束）将其标记为“离开环境”。至于怎么标记有很多种方式，比如特殊位的反转、维护一个列表等，这些并不重要，重要的是使用什么策略，原则上讲不能够释放进入环境的变量所占的内存，它们随时可能会被调用的到。</p> <p>垃圾回收器会在运行的时候给存储在内存中的所有变量加上标记，然后去掉环境中的变量以及被环境中变量所引用的变量（闭包），在这些完成之后仍存在标记的就是要删除的变量了，因为环境中的变量已经无法访问到这些变量了，然后垃圾回收器回收这些带有标记的变量机器所占空间。</p> <h5 id="引用计数-reference-counting"><a href="#引用计数-reference-counting" class="header-anchor">#</a> 引用计数(reference counting)</h5> <p>在低版本IE中经常会出现内存泄露，很多时候就是因为其采用引用计数方式进行垃圾回收。引用计数的策略是跟踪记录每个值被使用的次数，当声明了一个变量并将一个引用类型赋值给该变量的时候这个值的引用次数就加1，如果该变量的值变成了另外一个，则这个值的引用次数减1，当这个值的引用次数变为0的时候，说明没有变量在使用，这个值没法被访问了，因此可以将其占用的空间回收，这样垃圾回收器会在运行的时候清理掉引用次数为0的值占用的空间。</p> <p>这种方式没办法解决循环引用问题。比如对象A有一个属性指向对象B，而对象B也有有一个属性指向对象A，这样相互引用</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> a<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> b<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>prop<span class="token operator">=</span>b<span class="token punctuation">;</span>
            b<span class="token punctuation">.</span>prop<span class="token operator">=</span>a<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样a和b的引用次数都是2，即使在test()执行完成后，两个对象都已经离开环境，在标记清除的策略下是没有问题的，离开环境的就被清除，但是在引用计数策略下不行，因为这两个对象的引用次数仍然是2，不会变成0，所以其占用空间不会被清理，如果这个函数被多次调用，这样就会不断地有空间不会被回收，造成内存泄露。</p> <p>V8的垃圾回收模块Orinoco<a href="https://v8.dev/blog/trash-talk" target="_blank" rel="noopener noreferrer">大致是这样做的<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <ul><li>采用多线程的方式进行垃圾回收，尽量避免对JavaScript本身的代码执行造成暂停；</li> <li>利用浏览器渲染页面的空闲时间进行垃圾回收；</li> <li>根据<a href="https://people.cs.umass.edu/~emery/classes/cmpsci691s-fall2004/papers/p157-ungar.pdf" target="_blank" rel="noopener noreferrer">The Generational Hypothesis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，大多数对象的生命周期非常短暂，因此可以将对象根据生命周期进行区分，生命周期短的对象与生命周期长的对象采用不同的方式进行垃圾回收；</li> <li>对内存空间进行整理，消除内存碎片化，最大化利用释放的内存空间；</li></ul> <p>这篇文章参考了许多优秀作者的文章、博客，列举如下（排名不分先后）：</p> <ul><li><p><a href="https://blog.sessionstack.com/tagged/tutorial" target="_blank" rel="noopener noreferrer">HOW JAVASCRIPT WORKS系列文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://segmentfault.com/a/1190000013126460" target="_blank" rel="noopener noreferrer">JavaScript到底是解释型语言还是编译型语言?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://blog.fundebug.com/2019/07/16/how-does-v8-work/" target="_blank" rel="noopener noreferrer">JavaScript深入浅出第4课：V8引擎是如何工作的？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://blog.csdn.net/lq15310444798/article/details/77574320" target="_blank" rel="noopener noreferrer">浅谈javascript解析引擎解析过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.cnblogs.com/onepixel/p/5090799.html" target="_blank" rel="noopener noreferrer">探索JS引擎工作原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://blog.bitsrc.io/javascript-under-the-hood-632ccae06b27" target="_blank" rel="noopener noreferrer">JavaScript: Under the Hood<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://zhuanlan.zhihu.com/p/99395691" target="_blank" rel="noopener noreferrer">JavaScript 编译 - JIT (just-in-time) compiler 是怎么工作的<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://cnodejs.org/topic/579e341885dba6b12ac58583" target="_blank" rel="noopener noreferrer">Javascript 工作原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <h3 id="五、结尾"><a href="#五、结尾" class="header-anchor">#</a> 五、结尾</h3> <p>最后，是一凡的公众号，记录日常的学习与工作思考，大家一起努力~</p> <p><img src="https://imgkr.cn-bj.ufileos.com/bb57292c-561b-4e55-b820-91b76fd6b847.jpg" alt></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.5f5d3fba.js" defer></script><script src="/assets/js/6.e1ba9e42.js" defer></script>
  </body>
</html>
